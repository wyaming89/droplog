# 累计型指标使用指南

## 功能概述

累计型指标是指需要将一天内多次记录累加的指标，例如：
- **排尿量**：每次排尿记录一次，当天总量是所有记录的累加
- **饮水量**：每次喝水记录一次，当天总量是所有记录的累加
- **步数**：可能从不同设备多次记录，需要累加

## 已启用累计的指标

系统默认为以下指标启用了累计功能（每日累计）：

1. **饮水量** (`water_intake`) - 单位：ml
2. **排尿量** (`urine_output`) - 单位：ml
3. **步数** (`steps`) - 单位：步

## 使用方法

### 1. 在指标配置页面选择累计型指标

进入指标配置页面（点击右上角 ⚙️），选择上述任一累计型指标添加到你的配置中。

### 2. 记录数据

在主页面，累计型指标会显示特殊标识：

```
💧 饮水量 (ml) [累计]
本次增量: _____ ml
今日累计：500 ml
```

- **输入框**：填写本次的增量（如本次喝了 200ml）
- **今日累计**：自动显示今天已经累计的总量（如已喝了 500ml）

### 3. 保存记录

点击"保存记录"后：
- 系统保存本次增量（200ml）
- 自动更新今日累计（500 + 200 = 700ml）
- 历史记录显示每一次的单独记录

### 4. 多次记录

你可以在一天内多次记录同一个累计型指标：

**示例（排尿量）**：
- 上午 10:00 记录：200ml → 今日累计：200ml
- 中午 14:00 记录：300ml → 今日累计：500ml
- 下午 18:00 记录：250ml → 今日累计：750ml

每次保存后，"今日累计"会自动更新。

## 数据查看

### 历史记录

历史记录区域显示每一次的单独记录，包括：
- 记录时间
- 本次数值
- 所有指标的当次数据

### 每日汇总

系统在数据库中创建了视图 `daily_cumulative_metrics`，可查询每日累计统计：

```sql
SELECT * FROM daily_cumulative_metrics 
WHERE user_id = 你的用户ID 
AND record_date = '2026-01-26';
```

结果包括：
- `cumulative_value`：当日累计总量
- `record_count`：当日记录次数
- `first_record_time`：首次记录时间
- `last_record_time`：最后记录时间

## 自定义累计型指标

### 通过界面添加

1. 进入指标配置页面
2. 点击"+ 自定义指标"
3. 填写信息时：
   - 数据类型选择"数值"
   - 系统会自动识别某些指标（如名称包含"量"、"次数"等）
   - 或联系管理员手动设置

### 通过数据库设置

对于已存在的指标，可通过 SQL 设置为累计型：

```sql
UPDATE metric_templates 
SET 
    is_cumulative = true,
    cumulative_period = 'daily'
WHERE metric_key = '你的指标key';
```

参数说明：
- `is_cumulative`：是否为累计型（true/false）
- `cumulative_period`：累计周期
  - `'daily'`：每日累计（最常用）
  - `'weekly'`：每周累计
  - `'monthly'`：每月累计

## 技术实现

### 数据库设计

```sql
-- metric_templates 表增加字段
is_cumulative BOOLEAN DEFAULT false
cumulative_period VARCHAR(20) DEFAULT 'daily'

-- health_records 表
-- 每条记录存储的是增量值
metrics JSONB  -- {"water_intake": 200, ...}
```

### API 接口

#### GET /api/user-metrics
获取用户配置的指标，包含累计属性：
```json
{
  "metric_key": "water_intake",
  "metric_name": "饮水量",
  "is_cumulative": true,
  "cumulative_period": "daily"
}
```

#### GET /api/today-cumulative
获取当日各指标的累计值：
```json
{
  "success": true,
  "data": {
    "water_intake": 500,
    "urine_output": 300,
    "steps": 5000
  }
}
```

### 前端实现

- 页面加载时，自动请求当日累计数据
- 累计型指标显示"累计"徽章
- 输入框下方显示"今日累计：XXX"
- 保存后自动刷新累计数据

## 常见问题

### Q: 如何重置某天的累计数据？

删除该天的所有相关记录即可，系统会重新计算。

### Q: 跨天后累计数据会清零吗？

会。每天的累计是独立的，0点后重新开始累计。

### Q: 可以查看昨天的累计数据吗？

可以通过历史记录查看，或使用数据库视图：

```sql
SELECT * FROM daily_cumulative_metrics 
WHERE user_id = 你的用户ID 
AND record_date = '2026-01-25';
```

### Q: 累计型和非累计型指标可以同时使用吗？

可以。同一个配置中可以包含累计型（如饮水量）和非累计型（如体温）指标。

### Q: 误删除了一次记录，累计数据会自动调整吗？

会。删除记录后，系统会重新计算当日累计总量。

## 最佳实践

1. **及时记录**：建议每次饮水/排尿后立即记录，避免遗忘
2. **合理分组**：可以将相关的累计型指标放在一起（如饮水量和排尿量）
3. **定期查看**：通过历史记录查看每日累计趋势
4. **设置提醒**：可以利用手机提醒功能，定时记录

## 更新日志

### v2.1.0 - 累计型指标功能

- ✨ 新增累计型指标支持
- ✨ 自动计算当日累计总量
- ✨ 前端显示累计信息
- ✨ 默认启用饮水量、排尿量、步数累计
- 📊 新增每日累计统计视图
- 🔄 保存后自动更新累计显示
